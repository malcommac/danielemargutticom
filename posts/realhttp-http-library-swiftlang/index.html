<!DOCTYPE html><html lang="en" class="scroll-smooth"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="canonical" href="https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/"><meta name="generator" content="Astro v4.16.3"><!-- General Meta Tags --><title>Modern networking in Swift | danielemargutti.com</title><meta name="title" content="Modern networking in Swift | danielemargutti.com"><meta name="description" content="Modern networking library in Swift with async/await support"><meta name="author" content="Daniele Margutti"><link rel="sitemap" href="/sitemap-index.xml"><!-- Open Graph / Facebook --><meta property="og:title" content="Modern networking in Swift | danielemargutti.com"><meta property="og:description" content="Modern networking library in Swift with async/await support"><meta property="og:url" content="https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/"><meta property="og:image" content="https://www.danielemargutti.com/posts/modern-networking-in-swift.png"><!-- Article Published/Modified time --><meta property="article:published_time" content="2022-03-16T10:25:54.547Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/"><meta property="twitter:title" content="Modern networking in Swift | danielemargutti.com"><meta property="twitter:description" content="Modern networking library in Swift with async/await support"><meta property="twitter:image" content="https://www.danielemargutti.com/posts/modern-networking-in-swift.png"><!-- Google JSON-LD Structured data --><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Modern networking in Swift | danielemargutti.com","image":"https://www.danielemargutti.com/posts/modern-networking-in-swift.png","datePublished":"2022-03-16T10:25:54.547Z","author":[{"@type":"Person","name":"Daniele Margutti","url":"undefined"}]}</script><!-- Google Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&display=swap" rel="preload" as="style" onload="this.onload=null; this.rel='stylesheet';" crossorigin><meta name="theme-color" content=""><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script src="/toggle-theme.js" async></script><link rel="stylesheet" href="/_astro/about.CD5ccApv.css">
<style>a:where(.astro-blwjyjpt){position:relative;text-decoration-line:underline;text-decoration-style:dashed}a:where(.astro-blwjyjpt):hover{top:-.125rem;--tw-text-opacity: 1;color:rgba(var(--color-accent),var(--tw-text-opacity))}a:where(.astro-blwjyjpt):focus-visible{padding:.25rem}a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){margin-right:-1.25rem;height:1.5rem;width:1.5rem;--tw-scale-x: .95;--tw-scale-y: .95;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-text-opacity: 1;color:rgba(var(--color-text-base),var(--tw-text-opacity));opacity:.8}.group:where(.astro-blwjyjpt):hover a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){fill:rgb(var(--color-accent))}
@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0;mix-blend-mode:plus-lighter}to{opacity:1;mix-blend-mode:plus-lighter}}@keyframes astroFadeOut{0%{opacity:1;mix-blend-mode:plus-lighter}to{opacity:0;mix-blend-mode:plus-lighter}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
.social-icons:where(.astro-wkojbtzc){display:flex;flex-direction:column;flex-wrap:wrap;align-items:center;justify-content:center;gap:.25rem}@media (min-width: 640px){.social-icons:where(.astro-wkojbtzc){align-items:flex-start}}.link-button:where(.astro-wkojbtzc){--tw-scale-x: .9;--tw-scale-y: .9;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));padding:.5rem}.link-button:where(.astro-wkojbtzc):hover{--tw-rotate: 6deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@media (min-width: 640px){.link-button:where(.astro-wkojbtzc){padding:.25rem}}main:where(.astro-vj4tpspi){margin-left:auto;margin-right:auto;width:100%;max-width:48rem;padding-left:1rem;padding-right:1rem;padding-bottom:3rem}.post-title:where(.astro-vj4tpspi){font-size:1.5rem;line-height:2rem;font-weight:600;--tw-text-opacity: 1;color:rgba(var(--color-accent),var(--tw-text-opacity))}
</style><script type="module" src="/_astro/hoisted.BYHvv9Tn.js"></script><style>[data-astro-transition-scope="astro-plk3gbjq-1"] { view-transition-name: modern-networking-in-swift; }@layer astro { ::view-transition-old(modern-networking-in-swift) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(modern-networking-in-swift) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(modern-networking-in-swift) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(modern-networking-in-swift) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-36ssibgs-2"] { view-transition-name: leadership; }@layer astro { ::view-transition-old(leadership) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(leadership) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(leadership) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(leadership) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style></head> <body>  <header class="astro-3ef6ksr2"> <a id="skip-to-content" href="#main-content" class="astro-3ef6ksr2">Skip to content</a> <div class="nav-container astro-3ef6ksr2"> <div class="top-nav-wrap astro-3ef6ksr2"> <a href="/" class="logo whitespace-nowrap astro-3ef6ksr2"> danielemargutti.com </a> <nav id="nav-menu" class="astro-3ef6ksr2"> <button class="hamburger-menu focus-outline astro-3ef6ksr2" aria-label="Open Menu" aria-expanded="false" aria-controls="menu-items"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="menu-icon astro-3ef6ksr2"> <line x1="7" y1="12" x2="21" y2="12" class="line astro-3ef6ksr2"></line> <line x1="3" y1="6" x2="21" y2="6" class="line astro-3ef6ksr2"></line> <line x1="12" y1="18" x2="21" y2="18" class="line astro-3ef6ksr2"></line> <line x1="18" y1="6" x2="6" y2="18" class="close astro-3ef6ksr2"></line> <line x1="6" y1="6" x2="18" y2="18" class="close astro-3ef6ksr2"></line> </svg> </button> <ul id="menu-items" class="display-none sm:flex astro-3ef6ksr2"> <li class="astro-3ef6ksr2"> <a href="/posts/" class=" astro-3ef6ksr2">
Posts
</a> </li> <li class="astro-3ef6ksr2"> <a href="/tags/" class=" astro-3ef6ksr2">
Tags
</a> </li> <li class="astro-3ef6ksr2"> <a href="/about/" class=" astro-3ef6ksr2">
About
</a> </li> <li class="astro-3ef6ksr2"> <a href="/archives/" class="group inline-block hover:text-skin-accent focus-outline flex justify-center p-3 sm:p-1 astro-3ef6ksr2" aria-label="archives" title="Archives"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icons-tabler-outline !hidden sm:!inline-block astro-3ef6ksr2">  <path stroke="none" d="M0 0h24v24H0z" fill="none" class="astro-3ef6ksr2"></path> <path d="M3 4m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" class="astro-3ef6ksr2"></path> <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" class="astro-3ef6ksr2"></path> <path d="M10 12l4 0" class="astro-3ef6ksr2"></path>  </svg> <span class="sm:sr-only astro-3ef6ksr2">
Archives
</span> </a> </li> <li class="astro-3ef6ksr2"> <a href="/search/" class="group inline-block hover:text-skin-accent focus-outline p-3 sm:p-1  flex astro-3ef6ksr2" aria-label="search" title="Search"> <svg xmlns="http://www.w3.org/2000/svg" class="scale-125 sm:scale-100 astro-3ef6ksr2"><path d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z" class="astro-3ef6ksr2"></path> </svg> <span class="sr-only astro-3ef6ksr2">Search</span> </a> </li> <li class="astro-3ef6ksr2"> <button id="theme-btn" class="focus-outline astro-3ef6ksr2" title="Toggles light & dark" aria-label="auto" aria-live="polite"> <svg xmlns="http://www.w3.org/2000/svg" id="moon-svg" class="astro-3ef6ksr2"> <path d="M20.742 13.045a8.088 8.088 0 0 1-2.077.271c-2.135 0-4.14-.83-5.646-2.336a8.025 8.025 0 0 1-2.064-7.723A1 1 0 0 0 9.73 2.034a10.014 10.014 0 0 0-4.489 2.582c-3.898 3.898-3.898 10.243 0 14.143a9.937 9.937 0 0 0 7.072 2.93 9.93 9.93 0 0 0 7.07-2.929 10.007 10.007 0 0 0 2.583-4.491 1.001 1.001 0 0 0-1.224-1.224zm-2.772 4.301a7.947 7.947 0 0 1-5.656 2.343 7.953 7.953 0 0 1-5.658-2.344c-3.118-3.119-3.118-8.195 0-11.314a7.923 7.923 0 0 1 2.06-1.483 10.027 10.027 0 0 0 2.89 7.848 9.972 9.972 0 0 0 7.848 2.891 8.036 8.036 0 0 1-1.484 2.059z" class="astro-3ef6ksr2"></path> </svg> <svg xmlns="http://www.w3.org/2000/svg" id="sun-svg" class="astro-3ef6ksr2"> <path d="M6.993 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007S14.761 6.993 12 6.993 6.993 9.239 6.993 12zM12 8.993c1.658 0 3.007 1.349 3.007 3.007S13.658 15.007 12 15.007 8.993 13.658 8.993 12 10.342 8.993 12 8.993zM10.998 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2h-3zm17 0h3v2h-3zM4.219 18.363l2.12-2.122 1.415 1.414-2.12 2.122zM16.24 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.342 7.759 4.22 5.637l1.415-1.414 2.12 2.122zm13.434 10.605-1.414 1.414-2.122-2.122 1.414-1.414z" class="astro-3ef6ksr2"></path> </svg> </button> </li> </ul> </nav> </div> </div> <div class="max-w-3xl mx-auto px-4"> <hr class="border-skin-line" aria-hidden="true"> </div> </header>   <div class="mx-auto flex w-full max-w-3xl justify-start px-2 astro-vj4tpspi"> <button class="focus-outline mb-2 mt-8 flex hover:opacity-75 astro-vj4tpspi" onclick="(() => (history.length === 1) ? window.location = '/' : history.back())()"> <svg xmlns="http://www.w3.org/2000/svg" class="astro-vj4tpspi"><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg><span class="astro-vj4tpspi">Go back</span> </button> </div> <main id="main-content" class="astro-vj4tpspi"> <h1 class="post-title astro-vj4tpspi" data-astro-transition-scope="astro-plk3gbjq-1">Modern networking in Swift</h1> <div class="flex items-center space-x-2 opacity-80 my-2 astro-vj4tpspi"><svg xmlns="http://www.w3.org/2000/svg" class="scale-100 inline-block h-6 w-6 min-w-[1.375rem] fill-skin-base" aria-hidden="true"><path d="M7 11h2v2H7zm0 4h2v2H7zm4-4h2v2h-2zm0 4h2v2h-2zm4-4h2v2h-2zm0 4h2v2h-2z"></path><path d="M5 22h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2zM19 8l.001 12H5V8h14z"></path></svg><span class="sr-only">Published:</span><span class="italic text-base"><time dateTime="2022-03-16T10:25:54.547Z">Mar 16, 2022</time><span aria-hidden="true"> | </span><span class="sr-only"> at </span><span class="text-nowrap">11:25 AM</span><span aria-hidden="true"> | </span><a class="space-x-1.5 hover:opacity-75" href="https://github.com/satnaing/astro-paper/edit/main/src/content/blog/2022-03-16-realhttp.md" rel="noopener noreferrer" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icons-tabler-outline icon-tabler-edit inline-block !scale-90 fill-skin-base" aria-hidden="true"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path><path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path><path d="M16 5l3 3"></path></svg><span class="text-base italic">Suggest Changes</span></a></span></div> <article id="article" class="prose mx-auto mt-8 max-w-3xl astro-vj4tpspi"> <p>I’ve got a confession to make: Making networking layers has always been an exciting topic for me. Since the first days of iOS programming, in early 2007, each new project represented a fresh opportunity to refine or even break the entire approach I have used so far. My last attempt to write something on this topic <a href="https://danielemargutti.medium.com/network-layers-in-swift-updated-version-539d9c636b8">is dated 2017</a>, and I considered it a milestone after the switch to Swift language.</p>
<p>It’s been a long time since then; the language evolved like the system frameworks, and recently, with the introduction of the new <a href="https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html">Swift’s Concurrency Model</a>, I decided to take a further step forward and update my approach to networking layers. This new version went through a radical redesign that allows you to write a request in just <a href="https://github.com/immobiliare/RealHTTP">a single line of code</a>:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> todo </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> try</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> await</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> HTTPRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">https://jsonplaceholder.typicode.com/todos/1</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">fetch</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">Todo.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">self</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span></code></pre>
<p>At this time, you may be thinking: why should I make my client instead of relying on Alamofire? You’re right. A new implementation is inevitably immature and a source of issues for a certain amount of time. Despite all, you have the opportunity to create a fine-tuned integration with your software and avoid third-party dependencies. Moreover, you can take advantage of the new Apple technologies like <a href="https://developer.apple.com/documentation/foundation/urlsession">URLSession</a>, <a href="https://developer.apple.com/documentation/swift/codable">Codable</a>, <a href="https://developer.apple.com/videos/play/wwdc2021/10132/">Async/Await</a> &#x26; <a href="https://developer.apple.com/videos/play/wwdc2021/10133/">Actors</a>.<br>
You can find the code on GitHub; the project is called <a href="https://github.com/immobiliare/RealHTTP">RealHTTP</a>.</p>
<h2 id="the-client">The Client</h2>
<p>Let’s start by defining a type for representing a client. A client (formerly <a href="https://github.com/immobiliare/RealHTTP/blob/main/Sources/RealHTTP/Client/HTTPClient/HTTPClient.swift"><code>HTTPClient</code></a>) is a structure that comes with cookies, headers, security options, validator rules, timeout, and all other shared settings you may have in common between a group of requests. When you run a request in a client, all these properties are automatically from the client unless you customize it in a single request.</p>
<p>For example, when you execute an auth call and receive a JWT token, you may want to set the credentials at the client level, so any other request incorporate these data. The same happens with validators: to avoid duplicating the logic for data validation, you may want to create a new validator and let the client execute it for every request it fetches. A client is also an excellent candidate to implement retry mechanisms not available on basic URLSession implementation.</p>
<h2 id="the-request">The Request</h2>
<p>As you may imagine, a request (formerly <a href="https://github.com/immobiliare/RealHTTP/blob/main/Sources/RealHTTP/Client/HTTPRequest/HTTPRequest.swift"><code>HTTPRequest</code></a>) encapsulate a single call to an endpoint.</p>
<p>If you have read some other articles on this topic, you may find often a common choice is to use <a href="https://docs.swift.org/swift-book/LanguageGuide/Generics.html">Swift’s Generic</a> to handle the output of a request.<br>
Something like: struct <code>HTTPRequest&#x3C;Response></code>.</p>
<p>It allows you to strongly link the output object type to the request itself. While it’s a clever use of this fantastic construct, I found it makes the request a bit restrictive. From a practical perspective, you may need to use <a href="https://fabernovel.github.io/2020-06-03/approaches-to-type-erasure-in-swift">type erasure</a> to handle this object outside its context. Also, conceptually, I prefer to keep the request stages (fetch ~> get raw data ~> object decode) separated and easily identifiable.</p>
<p>For these reasons, I chose to avoid generics and return a raw response (HTTPResponse) from a request; the object will therefore include all the functions to allow easy decode (we’ll take a look at it below).</p>
<h2 id="configure-a-request">Configure a Request</h2>
<p>As we said, a request must allow us to easily set all the relevant attributes for a call, especially “HTTP Method” “Path,” “Query Variables,” and “Body.” What do Swift developers love more than anything else? Type-safety.</p>
<p>I’ve accomplished it in two ways: using configuration objects instead of literal and protocols to provide an extensible configuration along with a set of pre-made builder functions.</p>
<p>This is an example of request configuration:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> req </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> HTTPRequest</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#D6DEEB">url</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> URL</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">string</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">https://.../login</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">!</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">method</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#24292EFF;--shiki-dark:#C5E478">post</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">timeout</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 15</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">redirectMode</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> redirect</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">maxRetries</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 4</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">headers</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> HTTPHeaders</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">[</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">        .</span><span style="color:#D32F2F;--shiki-dark:#C792EA">init</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">name</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">userAgent</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">value</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> myAgent</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">        .</span><span style="color:#D32F2F;--shiki-dark:#C792EA">init</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">name</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">X-API-Experimental</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">value</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">true</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">    ]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> Setup URL query params &#x26; body</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">addQueryParameter</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">name</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">full</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">value</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">1</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">addQueryParameter</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">name</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">autosignout</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">value</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">30</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">    $0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">body</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">json</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">[</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">username</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> username, </span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">pwd</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> pwd]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<p>A typical example of type safety in action is the HTTP Method which became an enum; but also the headers which are managed using a custom <code>HTTPHeader</code> object, so you can write something like the following:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">req.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">headers</span><span style="color:#212121;--shiki-dark:#D6DEEB">[</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">contentType</span><span style="color:#212121;--shiki-dark:#D6DEEB">]</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#24292EFF;--shiki-dark:#C5E478">bmp</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">req.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">headers</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#D32F2F;--shiki-dark:#C792EA">init</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">[</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">  .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">contentType</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">bmp</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#D9F5DD">  "</span><span style="color:#22863A;--shiki-dark:#ECC48D">X-Custom-Header</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">abc</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span></code></pre>
<p>It supports both type-safe keys declaration and custom literal.</p>
<p>The best example of the usage of protocols is the body setup of the request. While it’s ultimately a binary stream, I decided to create a struct to hold the data content and add a set of utility methods to make the most common body structures (<code>HTTPBody</code>): multi-part form, JSON encoded objects, input stream, URL encoded body, etc.</p>
<p>The result is an:</p>
<ul>
<li><strong>Extensible interface</strong>: you can create a custom body container for your own data structure and set them directly. Just make it conforms to the <code>HTTPSerializableBody</code> protocol to allow the automatic serialization to data stream when needed.</li>
<li><strong>Easy to use APIs set</strong>: you can create all of these containers directly from the static methods offered by the <code>HTTPBody</code> struct</li>
</ul>
<p>Here’s an example of a multipart form:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">req.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">body</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">multipart</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">boundary</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> nil</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#7FDBCA">  $0</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">add</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">string</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">value</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">name</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">param_1</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#7FDBCA">  $0</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">add</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">fileURL</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> fileURL, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">name</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">image</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">mimeType</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">gif</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#7FDBCA">  $0</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">add</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">string</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">some other</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">name</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">param_2</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">}</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span></code></pre>
<p>Making a body with a JSON encoded object is also one line of code away:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> myObject </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> ...</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">req.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">body</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">json</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">myObject</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span></code></pre>
<p>When a request is passed to a client, the associated <code>URLSessionTask</code> is created automatically (in another thread) and the standard <code>URLSession</code> flow is therefore executed. The underlying logic still uses the <code>URLSessionDelegate</code>(and the other delegates of the family); you can find more in the <a href="https://github.com/immobiliare/RealHTTP/blob/main/Sources/RealHTTP/Client/Internal/HTTPDataLoader/HTTPDataLoader.swift"><code>HTTPDataLoader</code></a> class.</p>
<h2 id="execute-a-request">Execute a Request</h2>
<p><code>HTTPClient</code> takes full advantage of async/await, returning the raw response from the server. Running a request is easy: just call its <code>fetch()</code> function. It takes an optional client argument; if not set, the default singleton <code>HTTPClient</code> instance is used (it means cookies, headers, and other configuration settings are related to this shared instance).</p>
<p>Therefore, the request is added to the destination client and, accordingly with the configuration, will be executed asynchronously. Both serialization and deserialization of the data stream are made in another Task (for the sake of simplicity, another thread). This allows us to reduce the amount of work done on the <code>HTTPClient</code>.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> result: HTTPResponse </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> try</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> await</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> req.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">fetch</span><span style="color:#212121;--shiki-dark:#D6DEEB">()</span></span>
<span class="line"></span></code></pre>
<h2 id="the-response">The Response</h2>
<p>The request’s response is of type <code>HTTPResponse</code>; this object encapsulates all the stuff about the operation, including the raw data, the status code, optional error (received from the server or generated by a response validator), and the metrics data valid for integration debugging purposes.</p>
<p>The next step is to transform the raw response into a valid object (with/without a DAO). The <code>decode()</code> function allows you to pass the expected output object class. Usually, it’s an Codable object, but it’s also essential to enable custom object decoding, so you can also use any object that conforms to the <code>HTTPDecodableResponse</code> protocol. This protocol just defines a static function: static func decode(_ response: <code>HTTPResponse</code>) throws -> Self?.</p>
<p>Implementing the custom decode() function, you can do whatever you want to get the expected output. For example, I’m a firm fan of SwiftyJSON. It initially may seem a little more verbose than <code>‘Codable</code>,’ but it also offers more flexibility over the edge cases, better failure handling, and a less opaque transformation process.</p>
<p>Since most of the time, you may want just to end up with the output decoded object, the fetch() operation also presents the optional decode parameter, so you can do fetch &#x26; decode in a single pass without passing from the raw response.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> loggedUser </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> try</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> await</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> login.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">fetch</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">User.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">self</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"></span></code></pre>
<p>This alternate fetch() function combines both the fetch and decode in a single function; you may find it helpful when you don’t need to get the inner details of the response but just the decoded object.</p>
<h2 id="validatemodify-a-response">Validate/Modify a Response</h2>
<p>Using a custom client and not the shared one is to customize the logic behind the communication with your endpoint. For example, we would communicate with two different endpoints with different logic (oh man, the legacy environments…). It means both the result and errors are handled differently.</p>
<p>For example, the old legacy system is far away from being a REST-like system and puts errors inside the request’s body; the new one uses the shiny HTTP status code.</p>
<p>To handle these and more complex cases, we introduced the concept of response validators, which are very similar’s to Express’s Validators. Basically, a validator is defined by a protocol and a function that provides the request and its raw response, allowing you to decide the next step.</p>
<p>You can refuse the response and throw an error, accept the response or modify it, make an immediate retry or retry after executing an alternate request (this is the example for an expired JWT token that needs to be refreshed before making a further attempt with the original request).</p>
<p>Validators are executed in order before the response is sent to the application’s level. You can assign multiple validators to the client, and all of them can concur to the final output. This is a simplified version of the standard <code>HTTPResponseValidator</code>:</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">func</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> validate</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic">response</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">: HTTPResponse, </span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic">forRequest</span><span style="color:#FF9800;--shiki-dark:#7FDBCA"> request</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">: HTTPRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> -></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> HTTPResponseValidatorResult {</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">if</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA"> !</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">200</span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">..&#x3C;</span><span style="color:#1976D2;--shiki-dark:#F78C6C">300</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">).</span><span style="color:#6F42C1;--shiki-dark:#C5E478">contains</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">response.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">statusCode</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">//</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> invalid response, we want to fail the request with error</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">        throw</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> HTTPError.</span><span style="color:#24292EFF;--shiki-dark:#C5E478">invalidResponse</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#24292EFF;--shiki-dark:#C5E478">nextValidator</span><span style="color:#C2C3C5;--shiki-dark:#637777"> //</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> everything is okay, move to next validator</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<p>You can extend/configure it with different behavior. Moreover, the <code>HTTPAltResponseValidator</code> is the right validator to implement retry/after call logic. A validator can return one of the following actions defined by <code>HTTPResponseValidatorResult</code>:</p>
<ul>
<li><code>nextValidator</code>: just pass the handle to the next validator</li>
<li><code>failChain</code>: stop the chain and return an error for that request</li>
<li><code>retry</code>: retry the origin request with a strategy</li>
</ul>
<h2 id="retry-strategy">Retry Strategy</h2>
<p>One of the advantages of Alamofire is the infrastructure for adapting and retrying requests. Reimplementing it with callbacks is far from easy, but with async/await, it’s way easier. We want to implement two kinds of retry strategies: a simple retry with delay and a more complex one to execute an alternate call followed by the origin request.</p>
<p>Retry strategies are handled inside the <code>URLSessionDelegate</code> which is managed by a custom internal object called <code>HTTPDataLoader</code>.</p>
<p>The following is an over-simplified version of the logic you can find here(along with comments):</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> func</span><span style="color:#6F42C1;font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic"> fetch</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> async</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> throws</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> prepare the request and execute it</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> task </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> try</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> await</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> request.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">urlSessionTask</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">inClient</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> client</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> response </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> try</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> await</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> fetch</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">request, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">task</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> sessionTask</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> task</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    </span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> ask to validator the action to perform on this request</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">    let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> action </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> client.</span><span style="color:#6F42C1;--shiki-dark:#C5E478">validate</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">response</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> response, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">forRequest</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> request</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">    switch</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> action {</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">       case</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">failChain</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">let</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> error</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">          return</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> HTTPResponse</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#C5E478">error</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> error</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#C2C3C5;--shiki-dark:#637777"> //</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> fail with error</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                </span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">       case</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#6F42C1;--shiki-dark:#C5E478">retry</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">let</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> strategy</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">          if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> request.isAltRequest </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">||</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> request.reachedMaxRetries {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> alt request cannot be retried to avoid infinite loops</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> response</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">          } </span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">else</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> perform retry strategy</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            let</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> retryResponse </span><span style="color:#D32F2F;--shiki-dark:#7FDBCA">=</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> try</span><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic"> await</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> performRetryStrategy</span><span style="color:#212121;--shiki-dark:#D6DEEB">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">strategy, </span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478">                              forRequest</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> request, </span><span style="color:#6F42C1;--shiki-dark:#C5E478">task</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> sessionTask,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478">                              withResponse</span><span style="color:#212121;--shiki-dark:#82AAFF">:</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> response</span><span style="color:#212121;--shiki-dark:#D6DEEB">)</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">             return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> retryResponse</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">          }</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">       case</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> .</span><span style="color:#24292EFF;--shiki-dark:#C5E478">nextValidator</span><span style="color:#D32F2F;--shiki-dark:#C792EA">:</span></span>
<span class="line"><span style="color:#D32F2F;font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic">          return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> response </span><span style="color:#C2C3C5;--shiki-dark:#637777">//</span><span style="color:#C2C3C5;font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic"> validation okay</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">     }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<p>If you are thinking about using auto-retries for connectivity issues, consider using <a href="https://developer.apple.com/documentation/foundation/urlsessionconfiguration/2908812-waitsforconnectivity"><code>waitsForConnectivity</code></a> instead. If the request does fail with a network issue, it’s usually best to communicate an error to the user. With <a href="https://developer.apple.com/documentation/network/nwpathmonitor">NWPathMonitor</a> you can still monitor the connection to your server and retry automatically.</p>
<h2 id="debugging">Debugging</h2>
<p>Debugging is important; a standard way to exchange networking calls with backend teams is cURL. It doesn’t need an introduction. There is an extensionboth for <code>HTTPRequest</code> and <code>HTTPResponse</code> which generates a cURL command for the underlying <code>URLRequest</code>.</p>
<p>Ideally, you should call <code>cURLDescription</code> on request/response and you will get all the information automatically, including the parent’s <code>HTTPClient</code> settings.</p>
<h2 id="other-features">Other Features</h2>
<p>This article would have been a lot longer. We didn’t cover topics like SSL Pinning, Large File Download/Resume, Requests Mocking, and HTTP Caching. All these features are currently implemented and working on the GitHub project, so if you are interested you can look directly at sources. By the way, I’ve reused the same approaches you have seen above.</p> </article> <ul class="my-8 astro-vj4tpspi"> <li class="inline-block my-1 underline-offset-4 astro-blwjyjpt"> <a href="/tags/leadership/" class="text-sm pr-2 group astro-blwjyjpt" data-astro-transition-scope="astro-36ssibgs-2"> <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-blwjyjpt"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">leadership</span> </a> </li>  </ul> <div class="flex flex-col-reverse items-center justify-between gap-6 sm:flex-row-reverse sm:items-end sm:gap-4 astro-vj4tpspi"> <button id="back-to-top" class="focus-outline whitespace-nowrap py-1 hover:opacity-75 astro-vj4tpspi"> <svg xmlns="http://www.w3.org/2000/svg" class="rotate-90 astro-vj4tpspi"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg> <span class="astro-vj4tpspi">Back to Top</span> </button> <div class="social-icons astro-wkojbtzc"> <span class="italic astro-wkojbtzc">Share this post on:</span> <div class="text-center astro-wkojbtzc"> <a href="https://wa.me/?text=https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via WhatsApp"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 21l1.65 -3.8a9 9 0 1 1 3.4 2.9l-5.05 .9"></path>
      <path d="M9 10a0.5 .5 0 0 0 1 0v-1a0.5 .5 0 0 0 -1 0v1a5 5 0 0 0 5 5h1a0.5 .5 0 0 0 0 -1h-1a0.5 .5 0 0 0 0 1"></path>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post via WhatsApp</span> </a><a href="https://www.facebook.com/sharer.php?u=https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post on Facebook"> <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path
      d="M7 10v4h3v7h4v-7h3l1 -4h-4v-2a1 1 0 0 1 1 -1h3v-4h-3a5 5 0 0 0 -5 5v2h-3"
    ></path>
  </svg> <span class="sr-only astro-wkojbtzc">Share this post on Facebook</span> </a><a href="https://x.com/intent/post?url=https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post on X"> <svg  
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 4l11.733 16h4.267l-11.733 -16z" /><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772" />
    </svg> <span class="sr-only astro-wkojbtzc">Share this post on X</span> </a><a href="https://t.me/share/url?url=https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via Telegram"> <svg
        xmlns="http://www.w3.org/2000/svg"
        class="icon-tabler"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4"></path>
      </svg> <span class="sr-only astro-wkojbtzc">Share this post via Telegram</span> </a><a href="https://pinterest.com/pin/create/button/?url=https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post on Pinterest"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <line x1="8" y1="20" x2="12" y2="11"></line>
      <path d="M10.7 14c.437 1.263 1.43 2 2.55 2c2.071 0 3.75 -1.554 3.75 -4a5 5 0 1 0 -9.7 1.7"></path>
      <circle cx="12" cy="12" r="9"></circle>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post on Pinterest</span> </a><a href="mailto:?subject=See%20this%20post&#38;body=https://www.danielemargutti.com/posts/realhttp-http-library-swiftlang/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via email"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <rect x="3" y="5" width="18" height="14" rx="2"></rect>
      <polyline points="3 7 12 13 21 7"></polyline>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post via email</span> </a> </div> </div>  </div> <script src="https://giscus.app/client.js" data-repo="malcommac/danielemargutticom" data-repo-id="R_kgDONdFfXw" data-category="Announcements" data-category-id="DIC_kwDONdFfX84ClMmD" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async>
    </script> <hr class="my-6 border-dashed astro-vj4tpspi"> <!-- Previous/Next Post Buttons --> <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 astro-vj4tpspi"> <a href="/posts/broken-window-principle-applied-to-software" class="flex w-full gap-1 hover:opacity-75 astro-vj4tpspi"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-left flex-none astro-vj4tpspi">  <path stroke="none" d="M0 0h24v24H0z" fill="none" class="astro-vj4tpspi"></path> <path d="M15 6l-6 6l6 6" class="astro-vj4tpspi"></path>  </svg> <div class="astro-vj4tpspi"> <span class="astro-vj4tpspi">Previous Post</span> <div class="text-sm text-skin-accent/85 astro-vj4tpspi">The broken window principle applied to software</div> </div> </a> <a href="/posts/the-economy-of-tech-debt" class="flex w-full justify-end gap-1 text-right hover:opacity-75 sm:col-start-2 astro-vj4tpspi"> <div class="astro-vj4tpspi"> <span class="astro-vj4tpspi">Next Post</span> <div class="text-sm text-skin-accent/85 astro-vj4tpspi">The economy of tech debt</div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-right flex-none astro-vj4tpspi">  <path stroke="none" d="M0 0h24v24H0z" fill="none" class="astro-vj4tpspi"></path> <path d="M9 6l6 6l-6 6" class="astro-vj4tpspi"></path>  </svg> </a> </div> </main> <footer class="mt-auto astro-sz7xmlte"> <div class="max-w-3xl mx-auto px-0"> <hr class="border-skin-line" aria-hidden="true"> </div> <div class="footer-wrapper astro-sz7xmlte"> <div class="social-icons flex astro-upu6fzxr"> <a href="https://github.com/danielemargutti" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title=" danielemargutti.com on Github"> <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path
      d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"
    ></path>
  </svg> <span class="sr-only astro-upu6fzxr"> danielemargutti.com on Github</span> </a><a href="http://linkedin.com/in/danielemargutti" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title="danielemargutti.com on LinkedIn"> <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <rect x="4" y="4" width="16" height="16" rx="2"></rect>
    <line x1="8" y1="11" x2="8" y2="16"></line>
    <line x1="8" y1="8" x2="8" y2="8.01"></line>
    <line x1="12" y1="16" x2="12" y2="11"></line>
    <path d="M16 16v-3a2 2 0 0 0 -4 0"></path>
  </svg> <span class="sr-only astro-upu6fzxr">danielemargutti.com on LinkedIn</span> </a><a href="https://x.com/danielemargutti" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title="danielemargutti.com on X"> <svg  
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 4l11.733 16h4.267l-11.733 -16z" /><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772" />
    </svg> <span class="sr-only astro-upu6fzxr">danielemargutti.com on X</span> </a> </div>  <div class="copyright-wrapper astro-sz7xmlte"> <span class="astro-sz7xmlte">Copyright &#169; 2024</span> <span class="separator astro-sz7xmlte">&nbsp;|&nbsp;</span> <span class="astro-sz7xmlte">Made in Rome.</span> </div> </div> </footer>   </body></html>  <script data-astro-rerun>
  /** Create a progress indicator
   *  at the top */
  function createProgressBar() {
    // Create the main container div
    const progressContainer = document.createElement("div");
    progressContainer.className =
      "progress-container fixed top-0 z-10 h-1 w-full bg-skin-fill";

    // Create the progress bar div
    const progressBar = document.createElement("div");
    progressBar.className = "progress-bar h-1 w-0 bg-skin-accent";
    progressBar.id = "myBar";

    // Append the progress bar to the progress container
    progressContainer.appendChild(progressBar);

    // Append the progress container to the document body or any other desired parent element
    document.body.appendChild(progressContainer);
  }
  createProgressBar();

  /** Update the progress bar
   *  when user scrolls */
  function updateScrollProgress() {
    document.addEventListener("scroll", () => {
      const winScroll =
        document.body.scrollTop || document.documentElement.scrollTop;
      const height =
        document.documentElement.scrollHeight -
        document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      if (document) {
        const myBar = document.getElementById("myBar");
        if (myBar) {
          myBar.style.width = scrolled + "%";
        }
      }
    });
  }
  updateScrollProgress();

  /** Attaches links to headings in the document,
   *  allowing sharing of sections easily */
  function addHeadingLinks() {
    const headings = Array.from(
      document.querySelectorAll("h2, h3, h4, h5, h6")
    );
    for (const heading of headings) {
      heading.classList.add("group");
      const link = document.createElement("a");
      link.className =
        "heading-link ml-2 opacity-0 group-hover:opacity-100 focus:opacity-100";
      link.href = "#" + heading.id;

      const span = document.createElement("span");
      span.ariaHidden = "true";
      span.innerText = "#";
      link.appendChild(span);
      heading.appendChild(link);
    }
  }
  addHeadingLinks();

  /** Attaches copy buttons to code blocks in the document,
   * allowing users to copy code easily. */
  function attachCopyButtons() {
    const copyButtonLabel = "Copy";
    const codeBlocks = Array.from(document.querySelectorAll("pre"));

    for (const codeBlock of codeBlocks) {
      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";

      const copyButton = document.createElement("button");
      copyButton.className =
        "copy-code absolute right-3 -top-3 rounded bg-skin-card px-2 py-1 text-xs leading-4 text-skin-base font-medium";
      copyButton.innerHTML = copyButtonLabel;
      codeBlock.setAttribute("tabindex", "0");
      codeBlock.appendChild(copyButton);

      // wrap codebock with relative parent element
      codeBlock?.parentNode?.insertBefore(wrapper, codeBlock);
      wrapper.appendChild(codeBlock);

      copyButton.addEventListener("click", async () => {
        await copyCode(codeBlock, copyButton);
      });
    }

    async function copyCode(block, button) {
      const code = block.querySelector("code");
      const text = code?.innerText;

      await navigator.clipboard.writeText(text ?? "");

      // visual feedback that task is completed
      button.innerText = "Copied";

      setTimeout(() => {
        button.innerText = copyButtonLabel;
      }, 700);
    }
  }
  attachCopyButtons();

  /** Scrolls the document to the top when
   * the "Back to Top" button is clicked. */
  function backToTop() {
    document.querySelector("#back-to-top")?.addEventListener("click", () => {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    });
  }
  backToTop();

  /* Go to page start after page swap */
  document.addEventListener("astro:after-swap", () =>
    window.scrollTo({ left: 0, top: 0, behavior: "instant" })
  );
</script>